<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu&family=Poor+Story&display=swap" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/gh/bbbootstrap/libraries@main/datedropper.css" rel="stylesheet"/>
    <title>í˜„ë‚˜</title>
    <style>
        .btn-outline-primary:hover {
            border-color: #ff007b;
            color: #ff007b;
            background-color: rgba(255, 0, 123, 0.1);
        }
        .picker-input:hover{
        color: #ff007b;
        }
        .btn:hover {
        color: #ff007b;
        }
        .btn:hover {
        color: #ff007b;
        }
        .add-btn:hover {
        color: #000000; /* hover ì‹œ í°íŠ¸ ìƒ‰ìƒ ë³€ê²½ */
        background-color: #ff007b; /* hover ì‹œ ë°°ê²½ ìƒ‰ìƒ ë³€ê²½ */
        background-color: rgba(255, 0, 123, 0.1);
        }
        .btn-outline-primary:not(:disabled):not(.disabled).active,
        .btn-outline-primary:not(:disabled):not(.disabled):active,
        .show>.btn-outline-primary.dropdown-toggle {
            color: #fff;
            background-color: rgba(255, 0, 123, 0.5);
            border-color: #ff007b;
            box-shadow: inset 0 0 0 2px rgba(255, 0, 100, 0.5) !important;
        }
        #app-container {
            background-color: #fff;
            border-radius: 5px;
            margin: 0 auto;
            width : 80%;
        }
        #map-container {
            border: 2px solid #333;
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            width: 80%;
        }
        #map {
            width: 90%;
            height: 400px;
        }
        .list-group {
            margin: 20px 0;
        }
        .custom-backdrop {
        background-color: rgba(123, 31, 162, 0.7) !important;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding : 12px;
        }
        .place-item {
            cursor: pointer;
        }
        .place-item.selected {
            font-weight: bold;
            background-color: #f0f0f0;
        }
        .day-btn {
            margin-right: 5px;
        }
        .day-section {
            display: none;
        }
        .day-section.active {
            display: block;
        }
        .places {
            flex: 1;
        }
        .day-selection {
           flex: 3;
        }
        .center-text {
        text-align: center;
        }
        #addressResults {
            max-height: 400px; /* ì›í•˜ëŠ” ë†’ì´ë¡œ ì¡°ì • ê°€ëŠ¥ */
            overflow-y: auto;
        }
        .selected-place {
            background-color: #d3d3d3;
        }
        .popout {
            animation: popout 0.5s ease-out;
        }

        @keyframes popout {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .selected-item {
            cursor: pointer;
            margin-bottom: 5px;
            color: #000;
        }
        #floatingLabel {
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
            position: absolute; /* ì¹´ë“œì˜ ìœ„ì¹˜ì— ìƒëŒ€ì ìœ¼ë¡œ ë°°ì¹˜ */
            bottom: 20px; /* ì¹´ë“œ í•˜ë‹¨ì—ì„œ 20px */
            right: 20px; /* ì¹´ë“œ ì˜¤ë¥¸ìª½ì—ì„œ 20px */
            background: rgba(0, 0, 0, 0.7); /* ë°˜íˆ¬ëª… ê²€ì • ë°°ê²½ */
            color: #fff; /* í°ìƒ‰ í°íŠ¸ */
            padding: 10px;
            border-radius: 5px;
            z-index: 9999; /* ê°€ì¥ ìœ„ì— í‘œì‹œë˜ë„ë¡ ì„¤ì • */
        }
        .selected-item.active-border {
            border: 2px solid red;
            font-weight: bold;
            background-color: #f0f0f0;
        }
        .card-container {
            position: relative; /* ì¹´ë“œì˜ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì • */
        }
    </style>
</head>
<body>
<section id="app-container" style="position: relative; padding-bottom: 140px; font-family: Poor Story">
    <div class="container">
        <div id="selectedLocation" class="mb-3">
            <h4><span id="locationDisplay"></span></h4>
        </div>
        <div id="map-container">
            <div id="map"></div>
        </div>
        <div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="locationModalLabel">Select Location</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="form-group">
                                <label for="provinceSelect">ê´‘ì—­ì‹œ/ë„</label>
                                <select id="provinceSelect" class="form-control" onchange="fetchCities()">
                                    <option value="">select</option>
                                    {% for Areacode in Areacodes %}
                                    <option value="{{ Areacode.code }}">{{ Areacode.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="citySelect">ì‹œ/êµ°/êµ¬</label>
                                <select id="citySelect" class="form-control">
                                    <option value="">select</option>
                                    {% for citydistrict in citydistricts %}
                                    <option value="{{ citydistrict.code }}">{{ citydistrict.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn text-white" style="background-color: #935d8c;" data-dismiss="modal">
                            Close
                        </button>
                        <button type="button" class="btn text-white" style="background-color: #935d8c;" data-dismiss="modal" onclick="saveLocation()">
                            Save changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-3">
        <div class="row">
            <!-- ì™¼ìª½ì— ë²„íŠ¼ë“¤ ë°°ì¹˜ -->
            <div class="col-md-6 d-flex justify-content-center align-items-center">
                <button type="button" class="btn mr-4" style="border-color: black; background-color: #ffffff; margin-top: 10px;" data-toggle="modal" data-target="#locationModal">
                    Select Location
                </button>
                <button type="button" class="btn" style="border-color: black; background-color: #ffffff; margin-top: 10px;" data-toggle="modal" data-target="#categoryModal">
                    Select Category
                </button>
            </div>
            <div class="col-md-6">
                <div class="row">
                    <div class="col-md-4" style="margin-top: -20px;">
                        <label>From</label>
                        <input type="text" id="startDate" class="form-control" style="border-color: black; background-color: #ffffff;">
                    </div>
                    <div class="col-md-4" style="margin-top: -20px;">
                        <label>To</label>
                        <input type="text" id="endDate" class="form-control" style="border-color: black; background-color: #ffffff;">
                    </div>
                    <div class="col-md-4" style="margin-top: -20px;">
                        <label>âœ¨</label>
                        <button id="addTripButton" class="btn" style="border-color: black; background-color: #ffffff;">
                            Add a trip
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒí•˜ëŠ” ëª¨ë‹¬ -->
    <div class="modal fade" id="categoryModal" tabindex="-1" role="dialog" aria-labelledby="categoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalLabel">select category</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm" method="GET" action="{% url 'Jpage:get_data' %}">
                        <div class="form-group">
                            <label for="selectCategory1">ëŒ€ë¶„ë¥˜</label>
                            <select class="form-control" id="selectCategory1" name="cat1_code" onchange="fetchMiddleCategories()">
                                <option value="">select</option>
                                {% for largecategory in largecategories %}
                                <option value="{{ largecategory.code }}">{{ largecategory.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="selectCategory2">ì¤‘ë¶„ë¥˜</label>
                            <select class="form-control" id="selectCategory2" name="cat2_code" onchange="fetchSmallCategories()">
                                <option value="">select</option>
                                {% for middlecategory in middlecategories %}
                                <option value="{{ middlecategory.code }}">{{ middlecategory.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="selectCategory3">ì†Œë¶„ë¥˜</label>
                            <select class="form-control" id="selectCategory3">
                                <option value="">select</option>
                                {% for smallcategory in smallcategories %}
                                <option value="{{ smallcategory.code }}">{{ smallcategory.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn text-white" style="background-color: #935d8c;" data-dismiss="modal">Close
                    </button>
                    <button type="button" class="btn text-white" style="background-color: #935d8c;" data-dismiss="modal" onclick="saveCategory()">Save changes
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="selectedcategory" class="col-md-6 d-flex justify-content-center align-items-center mt-4">
        <h4><span id="categoryDisplay"></span></h4>
    </div>
    <div class="container mt-2">
        <div class="row">
            <!-- ì¥ì†Œ ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ -->
            <div class="col-md-6 d-flex justify-content-center align-items-center position-relative">
                <div class="card place-card" style="width: 400px; height: 400px; background-color: #f5f5f5; border-radius: 0px; box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.5);">
                    <div class="card-body">
                        <h3 class="card-title text-center">Place List âœï¸</h3>
                        <div class="card-text" style="max-height: 280px; overflow-y: auto;">
                            <ul id="place" class="list-group">
                                <!-- ì—¬ê¸°ì— ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œë“¤ ì¶”ê°€ -->
                            </ul>
                        </div>
                    </div>
                    <button id="addBtn" class="btn add-btn">ì¶”ê°€</button>
                </div>
            </div>

            <!-- ì¼ì°¨ë³„ ì„ íƒëœ ì¥ì†Œ ëª©ë¡ ì¹´ë“œ -->
            <div class="col-md-6 d-flex justify-content-center align-items-center position-relative">
                <div class="card" style="width: 400px; height: 400px; background-color: #f5f5f5; border-radius: 0px; box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.5);">
                    <div class="card-body">
                        <div class="btn-group d-flex justify-content-center" role="group" aria-label="ì¼ì°¨ ì„ íƒ">
                            <div id="dayButtons"></div>
                        </div>
                        <div id="day-sections" class="mt-4"></div>
                    </div>
                    <!-- ë²„íŠ¼ì„ ì¹´ë“œì˜ ì˜¤ë¥¸ìª½ í•˜ë‹¨ì— ìœ„ì¹˜ì‹œí‚µë‹ˆë‹¤. -->
                    <button type="button" id="openModalButton" class="btn add-btn" data-toggle="modal" data-target="#addressModal">ì¥ì†Œ ì¶”ê°€</button>
                </div>
                <div id="floatingLabel">
                    ë‘ ë²ˆ í´ë¦­í•˜ë©´ ì‚­ì œë©ë‹ˆë‹¤.
                </div>
            </div>
        </div>

        <!-- ëª¨ë‹¬ -->
        <div class="modal fade" id="addressModal">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <!-- ëª¨ë‹¬ í—¤ë” -->
                    <div class="modal-header">
                        <h5 class="modal-title">ì£¼ì†Œ ê²€ìƒ‰</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <!-- ëª¨ë‹¬ ë°”ë”” -->
                    <div class="modal-body">
                        <div class="input-group">
                            <input type="text" id="addressInput" class="form-control" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                            <div class="input-group-append">
                                <button type="button" id="searchButton" class="btn text-white" style="background-color: #935d8c;">ê²€ìƒ‰</button>
                            </div>
                        </div>
                        <div id="addressResults" class="overflow-auto mt-3"></div>
                    </div>
                    <!-- ëª¨ë‹¬ í‘¸í„° -->
                    <div class="modal-footer">
                        <button type="button" id="addSelectedPlaceButton" class="btn text-white" style="background-color: #935d8c; font-size:16px;">ì¶”ê°€</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
            <button id="saveButton" class="btn" data-toggle="modal" data-target="#titleModal"
                    style="border-color: black;  background-color: #ffffff; position: absolute; right: 20px; bottom: 20px; padding: 12px 24px; font-size: 16px;">
                Save Plan
            </button>
            <div class="modal fade" id="titleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="planTitle" class="form-control">
                        </div>
                        <div class="modal-footer">
                            <button type="button" id="modalSaveButton" class="btn text-white"
                                    style="background-color: #935d8c;"
                                    onclick="saveTitle()">ì €ì¥
                            </button>
                        </div>
                    </div>
                </div>
            </div>
</section>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/bbbootstrap/libraries@main/datedropper.js"></script>
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=64ca09990c4ef115e5bdda00a2c4bc44"></script>
<script>
    var selectedCity = ''; // ì„ íƒëœ ë„ì‹œ ì½”ë“œ
    var selectedProvince = ''; // ì„ íƒëœ ê´‘ì—­ì‹œ/ë„ ì½”ë“œ

    function fetchCities() {
        var AreaCode = document.getElementById('provinceSelect').value;
        var citydistrictSelect = document.getElementById('citySelect');

        $.ajax({
            url: '/Jpage/citydistrict/',
            type: 'GET',
            data: {
                'areacode': AreaCode
            },
            success: function(data) {
                data.citydistricts.forEach(function(city) {
                    var option = document.createElement('option');
                    option.value = city.code;
                    option.textContent = city.name;
                    citydistrictSelect.appendChild(option);
                });
            },
            error: function(xhr, status, error) {
                console.error('Error fetching citydistrict:', error);
            }
        });
    }

    function saveLocation() {
        selectedProvince = document.getElementById('provinceSelect').value;
        selectedCity = document.getElementById('citySelect').value;
        updateLocationDisplay();

        if (selectedProvince && selectedCity) {
            fetchPlaces();
        }
    }

    function updateLocationDisplay() {
        var provinceName = document.querySelector('#provinceSelect option:checked').textContent;
        var cityName = document.querySelector('#citySelect option:checked').textContent;
        var locationDisplay = document.getElementById('locationDisplay');
        console.log('City name:', cityName);
        console.log('Province name:', provinceName);

         if (provinceName && cityName) {
    locationDisplay.textContent = `${provinceName} ${cityName} ì—¬í–‰ ê³„íšì„œ`;
    locationDisplay.innerHTML += ' âœˆï¸'; // ì´ëª¨í‹°ì½˜ ì¶”ê°€
} else {
    locationDisplay.textContent = 'ìœ„ì¹˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
}
}

    $(document).ready(function() {
        $('#locationModal').on('show.bs.modal', function () {
            $('.modal-backdrop').addClass('custom-backdrop'); // backdropì— custom-backdrop í´ë˜ìŠ¤ ì¶”ê°€
        });

        $('#locationModal').on('hidden.bs.modal', function () {
            $('.modal-backdrop').removeClass('custom-backdrop'); // backdropì—ì„œ custom-backdrop í´ë˜ìŠ¤ ì œê±°
        });
    });
</script>
<script>
    var selectedCategory1 = '';
    var selectedCategory2 = '';
    var selectedCategory3 = '';
    var selectedPlaces = [];

    function fetchMiddleCategories() {
        var largeCategory = document.getElementById('selectCategory1').value;
        var middleCategorySelect = document.getElementById('selectCategory2');
        middleCategorySelect.innerHTML = '<option value="">select</option>'; // ì´ˆê¸°í™”

        $.ajax({
            url: '/middlecategory/',
            type: 'GET',
            data: { 'cat1_code': largeCategory },
            success: function(data) {
                data.middlecategories.forEach(function(category) {
                    var option = document.createElement('option');
                    option.value = category.code;
                    option.textContent = category.name;
                    middleCategorySelect.appendChild(option);
                });
            },
            error: function(xhr, status, error) {
                console.error('Error fetching middle categories:', error);
            }
        });
    }

    function fetchSmallCategories() {
        var middleCategory = document.getElementById('selectCategory2').value;
        var smallCategorySelect = document.getElementById('selectCategory3');
        smallCategorySelect.innerHTML = '<option value="">select</option>'; // ì´ˆê¸°í™”

        $.ajax({
            url: '/smallcategory/',
            type: 'GET',
            data: { 'cat2_code': middleCategory },
            success: function(data) {
                data.smallcategories.forEach(function(category) {
                    var option = document.createElement('option');
                    option.value = category.code;
                    option.textContent = category.name;
                    smallCategorySelect.appendChild(option);
                });
            },
            error: function(xhr, status, error) {
                console.error('Error fetching small categories:', error);
            }
        });
    }

    function saveCategory() {
        selectedCategory1 = document.getElementById('selectCategory1').value;
        selectedCategory2 = document.getElementById('selectCategory2').value;
        selectedCategory3 = document.getElementById('selectCategory3').value;

        // ì„ íƒëœ ì¥ì†Œ ì´ˆê¸°í™”
        selectedPlaces = [];
        $('#place').empty(); // ê¸°ì¡´ì˜ ì¥ì†Œ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¹„ì›ë‹ˆë‹¤

        if (selectedCategory1 && selectedCategory2 && selectedCategory3) {
            fetchPlaces();
        }
        updateCategoryDisplay();
    }

    function updateCategoryDisplay() {
        var smallCategory = document.querySelector('#selectCategory3 option:checked')?.textContent;
        var categoryDisplay = document.getElementById('categoryDisplay');

        if (smallCategory) {
            categoryDisplay.textContent = `${smallCategory}ì˜ ê²€ìƒ‰ ê²°ê³¼ì…ë‹ˆë‹¤`;
            categoryDisplay.innerHTML += 'ğŸ”'; // ì´ëª¨í‹°ì½˜ ì¶”ê°€
        } else {
            categoryDisplay.textContent = 'ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
        }
    }

    function fetchPlaces() {
        var $placeList = $('#place');
        $placeList.empty(); // ê¸°ì¡´ì˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¹„ì›ë‹ˆë‹¤

        if (selectedCategory1 && selectedCategory2 && selectedCategory3) {
            $.ajax({
                url: '/place/',
                type: 'GET',
                data: {
                    'area_code': selectedProvince,
                    'city_code': selectedCity,
                    'category_code': selectedCategory3
                },
                success: function(data) {
                    // ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë„ì°©í•˜ë©´, <ul> ë¦¬ìŠ¤íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤
                    $.each(data.places, function(index, place) {
                        var $li = $('<li></li>')
                            .addClass('list-group-item place-item')
                            .attr('data-place-id', index + 1)
                            .text(place.title); // place ê°ì²´ì˜ title ì†ì„±ì— ì ‘ê·¼í•©ë‹ˆë‹¤
                        $placeList.append($li);
                    });

                    // ê¸°ì¡´ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ì œê±°í•œ í›„ ìƒˆë¡œìš´ í•¸ë“¤ëŸ¬ ë“±ë¡
                    $placeList.off('click', '.place-item').on('click', '.place-item', function() {
                        $(this).toggleClass('selected');
                        var placeId = $(this).data('place-id');
                        if ($(this).hasClass('selected')) {
                            selectedPlaces.push(placeId);
                        } else {
                            var index = selectedPlaces.indexOf(placeId);
                            if (index > -1) {
                                selectedPlaces.splice(index, 1);
                            }
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching places:', error);
                }
            });
        }
    }

    $(document).ready(function() {
        $('#categoryModal').on('show.bs.modal', function () {
            $('.modal-backdrop').addClass('custom-backdrop'); // backdropì— custom-backdrop í´ë˜ìŠ¤ ì¶”ê°€
        });

        $('#categoryModal').on('hidden.bs.modal', function () {
            $('.modal-backdrop').removeClass('custom-backdrop'); // backdropì—ì„œ custom-backdrop í´ë˜ìŠ¤ ì œê±°
        });
    });
</script>


<script>
    var markers = {}; // ê° ì¼ì°¨ë³„ ë§ˆì»¤ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•œ ê°ì²´
    var selectedPlaces = [];
    var selectedPlace = null; // í˜„ì¬ ì„ íƒëœ ì¥ì†Œ

    $(document).ready(function() {
            $('#startDate').dateDropper();
            $('#endDate').dateDropper();

            $('#addTripButton').click(function() {
                var startDate = new Date($('#startDate').val());
                var endDate = new Date($('#endDate').val());

                if (isNaN(startDate) || isNaN(endDate)) {
                    alert('ì‹œì‘ ë‚ ì§œì™€ ì¢…ë£Œ ë‚ ì§œë¥¼ ëª¨ë‘ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                    return;
                }

                if (startDate > endDate) {
                    alert('ì‹œì‘ ë‚ ì§œëŠ” ì¢…ë£Œ ë‚ ì§œë³´ë‹¤ ì´ì „ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }

                var numDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

                createDayButtons(numDays);
                createDaySections(numDays);
            });

            function createDayButtons(numDays) {
                var $buttonContainer = $('#dayButtons');
                $buttonContainer.empty(); // Clear existing buttons

                for (var i = 1; i <= numDays; i++) {
                    $buttonContainer.append(`
                        <button type="button" class="btn btn-outline-primary day-btn"
                            style="border-color: black; color: black;" data-day="${i}">${i}ì¼ì°¨
                        </button>
                    `);
                }
                if (numDays > 0) {
                    $('.day-btn[data-day="1"]').click();
                }
            }

            function createDaySections(numDays) {
                var $sectionContainer = $('#day-sections');
                $sectionContainer.empty(); // Clear existing sections

                for (var i = 1; i <= numDays; i++) {
                    $sectionContainer.append(`
                        <div id="day${i}" class="day-section mt-4" style="display: none;">
                            <h4>Day ${i}</h4>
                            <div class="card-text" style="max-height: 250px; overflow-y: auto;">
                                <ul id="selectedPlaces${i}" class="list-group">
                                    <!-- ì„ íƒí•œ ì¥ì†Œ ëª©ë¡ -->
                                </ul>
                            </div>
                        </div>
                    `);
                }
                if (numDays > 0) {
                    $('#day1').show();
                }
            }

            $(document).on('click', '.day-btn', function() {
                var day = $(this).data('day');
                $('.day-section').hide(); // Hide all sections
                $('#day' + day).show(); // Show the selected section
                $('.day-btn').removeClass('active'); // Deactivate all buttons
                $(this).addClass('active'); // Activate the clicked button
            });
        });




    // ì§€ë„ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” í•¨ìˆ˜
    function initMap() {
        map = new kakao.maps.Map(document.getElementById('map'), {
            center: new kakao.maps.LatLng(37.5665, 126.978), // ê¸°ë³¸ ì¤‘ì‹¬ ì¢Œí‘œ
            level: 3 // ê¸°ë³¸ ì¤Œ ë ˆë²¨
        });
        // ì§€ë„ íƒ€ì… ì»¨íŠ¸ë¡¤ ì¶”ê°€
        var mapTypeControl = new kakao.maps.MapTypeControl();
        map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

        // í™•ëŒ€/ì¶•ì†Œ ì»¨íŠ¸ë¡¤ ì¶”ê°€
        var zoomControl = new kakao.maps.ZoomControl();
        map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
    }

    // ì¼ì°¨ ì„ íƒ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    $(document).on('click', '.day-btn', function() {
        var day = $(this).data('day');
        $('.day-section').removeClass('active');
        $('#day' + day).addClass('active');
        $('.day-btn').removeClass('active');
        $(this).addClass('active');
        updateMarkers(day); // ì„ íƒëœ ì¼ì°¨ì˜ ë§ˆì»¤ë§Œ ì—…ë°ì´íŠ¸
    });

     // ì¥ì†Œ í•­ëª© í´ë¦­ ì´ë²¤íŠ¸
    $('.place-item').click(function() {
        $(this).toggleClass('selected');
        var placeId = $(this).data('place-id');
        if ($(this).hasClass('selected')) {
            selectedPlaces.push(placeId);
        } else {
            var index = selectedPlaces.indexOf(placeId);
            if (index > -1) {
                selectedPlaces.splice(index, 1);
            }
        }
    });

    function addMarker(day, placeName, lat, lng) {
        var markerPosition = new kakao.maps.LatLng(lat, lng);
        var marker = new kakao.maps.Marker({
            position: markerPosition,
            title: placeName
        });

        marker.setMap(map);
        if (!markers[day]) {
            markers[day] = [];
        }
        markers[day].push(marker);

        // ë§ˆì»¤ê°€ ì¶”ê°€ëœ í›„ ì§€ë„ì˜ ì¤‘ì‹¬ì„ ì—…ë°ì´íŠ¸
        updateMapCenterAndZoom(day);
    }

    function removeMarkers(day) {
        if (markers[day]) {
            markers[day].forEach(function(marker) {
                marker.setMap(null);
            });
            markers[day] = [];
        }
    }

    function updateMarkers(day) {
        // ëª¨ë“  ì¼ì°¨ì˜ ë§ˆì»¤ë¥¼ ì œê±°
        Object.keys(markers).forEach(function(existingDay) {
            removeMarkers(existingDay);
        });

        // í˜„ì¬ ì„ íƒëœ ì¼ì°¨ì˜ ë§ˆì»¤ë§Œ ì—…ë°ì´íŠ¸
        var selectedPlacesList = $('#selectedPlaces' + day);
        selectedPlacesList.find('li').each(function() {
            var placeItem = $(this).text().trim();
            $.ajax({
                url: '/coordinate/',
                type: 'GET',
                data: { 'placeName': placeItem },
                success: function(data) {
                    if (data.mapx !== undefined && data.mapy !== undefined) {
                        var lng = parseFloat(data.mapx);
                        var lat = parseFloat(data.mapy);
                        addMarker(day, placeItem, lat, lng);
                    } else {
                        console.error('Coordinates not found for place:', placeItem);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching place information:', error);
                }
            });
        });
    }

    function updateMapCenterAndZoom(day) {
        if (markers[day] && markers[day].length > 0) {
            var bounds = new kakao.maps.LatLngBounds();

            markers[day].forEach(function(marker) {
                bounds.extend(marker.getPosition());
            });

            map.setBounds(bounds);
        }
    }

    $('#addBtn').click(function() {
        var day = $('.day-btn.active').data('day');
        var selectedPlacesList = $('#selectedPlaces' + day);

        selectedPlaces.forEach(function(placeId) {
            var placeItem = $('.place-item[data-place-id="' + placeId + '"]').text().trim();
            var isAlreadyAdded = selectedPlacesList.find('li').filter(function() {
                return $(this).data('place-id') === placeId;
            }).length > 0;

            if (!isAlreadyAdded && placeItem) {
                // ì„ íƒëœ ì¥ì†Œë¥¼ ì¶”ê°€í•˜ê³  popout ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ ì¶”ê°€
                selectedPlacesList.append(`
            <li class="list-group-item selected-item popout" data-place-id="${placeId}">
                 ${placeItem}
            </li>
            `);

                // ë§ˆì»¤ ì¶”ê°€
                $.ajax({
                    url: '/coordinate/',
                    type: 'GET',
                    data: { 'placeName': placeItem },
                    success: function(data) {
                        if (data.mapx !== undefined && data.mapy !== undefined) {
                            var lng = parseFloat(data.mapx);
                            var lat = parseFloat(data.mapy);
                            addMarker(day, placeItem, lat, lng);
                        } else {
                            console.error('Coordinates not found for place:', placeItem);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching place information:', error);
                    }
                });
            }
        });

        selectedPlaces = [];
        $('.place-item').removeClass('selected');
    });

    $(document).on('click', '.selected-item', function() {
        var $item = $(this);

        // í”Œë¡œíŒ… ë¼ë²¨ í‘œì‹œ
        $('#floatingLabel').stop(true, true).fadeIn(300).delay(1500).fadeOut(300);

        // í´ë¦­ ì‹œ í…Œë‘ë¦¬ ìƒ‰ìƒ í† ê¸€
        $item.toggleClass('active-border');
    });

    $(document).on('dblclick', '.selected-item', function() {
        var $item = $(this);
        var placeId = $item.data('place-id');
        var placeName = $item.text().trim();

        // ì‚­ì œ ì• ë‹ˆë©”ì´ì…˜ ë° ì‚­ì œ
        $item.fadeOut(300, function() {
            $(this).remove(); // ì• ë‹ˆë©”ì´ì…˜ í›„ ì‚­ì œ
        });

        // selectedPlaces ë°°ì—´ì—ì„œ í•­ëª© ì œê±°
        selectedPlaces = selectedPlaces.filter(function(pid) { return pid !== placeId; });

        // ë§ˆì»¤ ì‚­ì œ
        var day = $('.day-btn.active').data('day');

        // ì¼ì°¨ë³„ ë§ˆì»¤ë¥¼ ì œê±°í•˜ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
        removeMarkerByPlaceName(day, placeName);
        updateMapCenterAndZoom(day);
    });

    function removeMarkerByPlaceName(day, placeName) {
        if (markers[day]) {
            for (var i = markers[day].length - 1; i >= 0; i--) {
                try {
                    var marker = markers[day][i];
                    var markerTitle = marker.getTitle().trim();
                    console.log('Comparing:', markerTitle, 'with', placeName);
                    if (markerTitle === placeName) {
                        marker.setMap(null); // ì§€ë„ì—ì„œ ë§ˆì»¤ ì œê±°
                        markers[day].splice(i, 1); // ë°°ì—´ì—ì„œ ë§ˆì»¤ ì œê±°
                        console.log(placeName, 'deleted from map and array', markers);
                    }
                } catch (e) {
                    console.error('Error removing marker:', e);
                }
            }
        }
    }

    // ë¬¸ì„œê°€ ì¤€ë¹„ë˜ì—ˆì„ ë•Œ ì§€ë„ ì´ˆê¸°í™”
    $(document).ready(function() {
        initMap();
    });

    // Kakao API í‚¤
    const kakaoApiKey = 'ìì‹ ì˜ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”';

    // ì¥ì†Œ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
    document.getElementById('openModalButton').addEventListener('click', function() {
        // ëª¨ë‹¬ í‘œì‹œ
        $('#addressModal').modal('show');
    });

    // ëª¨ë‹¬ì´ ë‹«í ë•Œ ì´ˆê¸°í™”
    $('#addressModal').on('hidden.bs.modal', function () {
        $('#addressInput').val('');
        $('#addressResults').empty();
    });

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
    document.getElementById('searchButton').addEventListener('click', function() {
        const addressInput = document.getElementById('addressInput').value;

        // Kakao API í˜¸ì¶œ URL
        const apiUrl = `https://dapi.kakao.com/v2/local/search/keyword.json?query=${encodeURIComponent(addressInput)}`;

        // Ajax ìš”ì²­
        fetch(apiUrl, {
            headers: {
                'Authorization': `KakaoAK ${kakaoApiKey}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Kakao API ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            return response.json();
        })
        .then(data => {
            // ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë¡œì§
            const resultsDiv = document.getElementById('addressResults');
            resultsDiv.innerHTML = ''; // ê¸°ì¡´ ê²°ê³¼ ì´ˆê¸°í™”

            if (data.documents && data.documents.length > 0) {
                data.documents.forEach(item => {
                    const address = item.road_address_name || item.address_name || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ';
                    const placeName = item.place_name || 'ì¥ì†Œ ì´ë¦„ ì—†ìŒ';
                    const x = item.x;
                    const y = item.y;
                    const resultElement = document.createElement('div');
                    resultElement.className = 'd-flex justify-content-between align-items-center border p-2';
                    resultElement.innerHTML = `
                        <span class="place-info">[${placeName}] ${address}</span>
                    `;
                    resultElement.addEventListener('click', function() {
                        selectPlace(placeName, address, resultElement, x, y);
                    });
                    resultsDiv.appendChild(resultElement);
                });
            } else {
                resultsDiv.textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
            }
        })
        .catch(error => {
            console.error('ì£¼ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', error);
            const resultsDiv = document.getElementById('addressResults');
            resultsDiv.textContent = 'ì£¼ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        });
    });

    function selectPlace(placeName, address, element, x, y) {
        const previouslySelected = document.querySelector('.selected-place');
        if (previouslySelected) {
            previouslySelected.classList.remove('selected-place');
        }
        element.classList.add('selected-place');
        selectedPlace = { placeName, address, x, y };
    }

    document.getElementById('addSelectedPlaceButton').addEventListener('click', function() {
        if (selectedPlace) {
            addPlace(selectedPlace.placeName, selectedPlace.x, selectedPlace.y);
        } else {
            alert('ì¥ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        }
    });

    function addPlace(placeName, x, y) {
        var day = $('.day-btn.active').data('day'); // í˜„ì¬ ì„ íƒëœ ì¼ì°¨ë¥¼ ê°€ì ¸ì˜´
        var $placeList = $('#selectedPlaces' + day); // í˜„ì¬ ì„ íƒëœ ì¼ì°¨ì˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜´

        // ì¤‘ë³µ ê²€ì‚¬ ë° ìƒˆë¡œìš´ ID ê³„ì‚°
        var isDuplicate = $placeList.find('li').filter(function() {
            return $(this).text().trim() === placeName.trim(); // ê³µë°± ì œê±°í•˜ì—¬ ë¹„êµ
        }).length > 0;

        if (isDuplicate) {
            alert('ì´ë¯¸ ì„ íƒí•œ ì¥ì†Œì…ë‹ˆë‹¤.');
            return;
        }

        // í˜„ì¬ ì‹œê°„ì„ ê¸°ë°˜ìœ¼ë¡œ ê³ ìœ í•œ placeId ìƒì„±
        var placeId = `place-${Date.now()}`; // í˜„ì¬ ì‹œê°„ì„ ì´ìš©í•˜ì—¬ ê³ ìœ í•œ ID ìƒì„±

        // ìƒˆë¡œìš´ ì•„ì´í…œ ìƒì„± ë° ì¶”ê°€
        var $li = $('<li></li>')
            .addClass('list-group-item place-item popout')
            .attr('data-place-id', placeId)
            .text(placeName) // ì •í™•í•œ ì¥ì†Œ ì´ë¦„ ì„¤ì •
            .css({
                'color': '#000',
                'transition': 'border 0.3s'
            })
            .on('click', function() {
                var $this = $(this);

                // í´ë¦­ ì‹œ í…Œë‘ë¦¬ ìƒ‰ìƒ í† ê¸€
                if ($this.hasClass('selected')) {
                    $this.removeClass('selected');
                    $this.css('border', '2px solid transparent'); // ê¸°ë³¸ í…Œë‘ë¦¬
                } else {
                    $this.addClass('selected');
                    $this.css('border', '2px solid red'); // í´ë¦­ ì‹œ í…Œë‘ë¦¬
                    $('#floatingLabel').stop(true, true).fadeIn(300).delay(1500).fadeOut(300);
                }
            })
            .on('dblclick', function() {
                // ë‘ ë²ˆ í´ë¦­ ì‹œ ì‚­ì œ ë° ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ ì¶”ê°€
                $(this).fadeOut(300, function() {
                    $(this).remove(); // ì• ë‹ˆë©”ì´ì…˜ í›„ ì‚­ì œ
                    removeMarkerByPlaceName(day, placeName);
                    updateMapCenterAndZoom(day);
                });
                var id = $(this).data('place-id');
                selectedPlaces = selectedPlaces.filter(function(pid) { return pid !== id; });
            });

        // ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
        $placeList.append($li);

        // ì„ íƒí•œ ì¥ì†Œë¥¼ ë°°ì—´ì— ì¶”ê°€
        selectedPlaces.push(placeId);

        addMarker(day, placeName, parseFloat(y), parseFloat(x));

        // ëª¨ë‹¬ì„ ë‹«ìŒ
        $('#addressModal').modal('hide');
    }
</script>
<script>
    var csrfToken = '{{ csrf_token }}';
    function getPlacesData() {
        var places = {};
        var daySections = document.querySelectorAll('.day-section');

        daySections.forEach(section => {
            var dayId = section.id; // e.g., 'day1', 'day2'
            var placesList = [];
            var ul = section.querySelector('ul');
            if (ul) {
                ul.querySelectorAll('li').forEach(li => {
                    placesList.push(li.textContent.trim());
                });
            }
            places[dayId] = placesList;
        });

        return places;
    }

    function generateTemporaryPK() {
        return 'PK-' + Math.random().toString(36).substr(2, 9);  // ëœë¤ ë¬¸ìì—´ ìƒì„±
    }

    function saveTitle() {
        var title = document.getElementById('planTitle').value.trim();
        if (!title) {
            alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        var city = document.querySelector('#citySelect option:checked').textContent;
        var province = document.querySelector('#provinceSelect option:checked').textContent;
        var places = getPlacesData(); // ë™ì ìœ¼ë¡œ places ê°ì²´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤
        var email = user.email;
        var PK = generateTemporaryPK();

        var data = JSON.stringify({
            'province': province,
            'city': city,
            'places': places,
            'plan_title': title,
            'email': email,
            'plan_id': PK
        });

        console.log('Data to be sent:', data); // ë””ë²„ê¹…ìš© ë¡œê·¸

        $.ajax({
            url: '/save_Plan/',  // ìš”ì²­ì„ ë³´ë‚¼ URL
            type: 'POST',
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': getCSRFToken()  // CSRF í† í°ì„ HTTP í—¤ë”ì— í¬í•¨
            },
            data: data,
            success: function(response) {
                console.log('Plan saved:', response.message);
                $('#titleModal').modal('hide'); // ë¶€íŠ¸ìŠ¤íŠ¸ë© ëª¨ë‹¬ì„ ë‹«ìŠµë‹ˆë‹¤
            },
            error: function(xhr, status, error) {
                console.error('Error saving plan:', xhr.responseText);
            }
        });
    }

    function getCSRFToken() {
        var csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        return csrfToken;
    }
</script>
<script>
    const user = {{ user|safe }};
    console.log("Logged-in user information:", user);
</script>
<script>
    function resizeIframe() {
        var iframe = window.parent.document.querySelector('iframe');
        if (iframe) {
            iframe.style.height = document.documentElement.scrollHeight + 'px';
        }
    }
    window.onload = resizeIframe;
    window.onresize = resizeIframe;
</script>
</body>
</html>
